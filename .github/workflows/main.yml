name: SarvCast Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '8.0'
          mysql root password: 'iWY]RgUhnqiu'
          mysql database: 'h273779_lgb'
          mysql user: 'h273779_lgb'
          mysql password: 'iWY]RgUhnqiu'

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        env:
          BROADCAST_DRIVER: log
          PUSHER_APP_KEY: dummy_key
          PUSHER_APP_SECRET: dummy_secret
          PUSHER_APP_ID: dummy_id
          PUSHER_APP_CLUSTER: mt1
        run: composer install


      # - name: Copy .env
      #   env:
      #     BROADCAST_DRIVER: log
      #     PUSHER_APP_KEY: dummy_key
      #     PUSHER_APP_SECRET: dummy_secret
      #     PUSHER_APP_ID: dummy_id
      #     PUSHER_APP_CLUSTER: mt1
      #   run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      # - name: Configure database for GitHub Actions
      #   run: |
      #     # Update .env file with GitHub Actions database credentials
      #     sed -i 's/DB_HOST=.*/DB_HOST=localhost/' .env
      #     sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
      #     sed -i 's/DB_DATABASE=.*/DB_DATABASE=h273779_lgb/' .env
      #     sed -i 's/DB_USERNAME=.*/DB_USERNAME=h273779_lgb/' .env
      #     sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=iWY]RgUhnqiu/' .env

      - name: Generate key
        env:
          BROADCAST_DRIVER: log
          PUSHER_APP_KEY: dummy_key
          PUSHER_APP_SECRET: dummy_secret
          PUSHER_APP_ID: dummy_id
          PUSHER_APP_CLUSTER: mt1
        run: php artisan key:generate --force

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Link Storage
        run: |
          echo "ðŸ”— Creating storage symbolic link..."
          php artisan storage:link || echo "âš ï¸ Storage link may already exist"
          echo "âœ… Storage link created successfully"

      - name: Create Public Images Directories
        run: |
          echo "ðŸ“ Creating public images directories..."
          mkdir -p public/images/categories
          mkdir -p public/images/stories
          mkdir -p public/images/episodes
          mkdir -p public/images/people
          mkdir -p public/images/users
          mkdir -p public/images/playlists
          mkdir -p public/images/timeline
          echo "âœ… Public images directories created successfully"

      - name: Set Public Images Permissions
        run: |
          echo "ðŸ” Setting public images permissions..."
          chmod -R 755 public/images
          echo "âœ… Public images permissions set successfully"

      - name: Test Database Connection
        run: |
          echo "ðŸ” Testing database connection..."
          php artisan tinker --execute="echo 'Database connection: ' . (DB::connection()->getPdo() ? 'OK' : 'FAILED') . PHP_EOL;"


      - name: Pre-deployment Cache Clear
        run: |
          echo "ðŸ§¹ Clearing pre-deployment caches..."
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          echo "âœ… Pre-deployment caches cleared"

      # Set repo secrets: FTP_SERVER, FTP_USERNAME, FTP_PASSWORD (Settings â†’ Secrets)
      - name: ðŸ“‚ Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.0.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /
          log-level: verbose
          exclude: |
            .env
            .env.*
            node_modules/
            .git/
            .github/
            tests/
            phpunit.xml
            *.md
            .styleci.yml
            storage/logs/*
            storage/framework/cache/*
            storage/framework/sessions/*
            storage/framework/views/*
            bootstrap/cache/*
            vendor

      # - name: Notify Telegram
      #   env:
      #     TELEGRAM_BOT_TOKEN: 7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc
      #     TELEGRAM_CHAT_ID: -1002796302613_97
      #     GITHUB_ACTOR: ${{ github.actor }}
      #     COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      #   run: |
      #     FORMATTED_COMMIT_MESSAGE=$(echo "${COMMIT_MESSAGE}" | sed 's/$/\\n/' | sed ':a;N;$!ba;s/\n/\\n/g')
      #     MESSAGE=$(echo -e "ðŸ˜Ž <b>SarvCast Admin Dashboard</b> ðŸ˜Ž\n\nðŸ‘Œ <b>Status:</b> Deployment Complete\n\nðŸ‘¤ <b>User:</b> ${GITHUB_ACTOR}\n <blockquote>${FORMATTED_COMMIT_MESSAGE}</blockquote>")
      #     curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
      #       -d chat_id=${TELEGRAM_CHAT_ID} \
      #       -d text="${MESSAGE}" \
      #       -d parse_mode="HTML"

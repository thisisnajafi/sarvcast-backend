on:
  push:
    branches:
      - main

name: Deploy Laravel Backend via FTP

env:
  FTP_SERVER: "ftp.sarvcast.ir"
  FTP_USERNAME: "my@sarvcast.ir"
  FTP_PASSWORD: "Prof48017421@#"
  SITE_URL: "https://my.sarvcast.ir"
  DEPLOY_TOKEN: "sarvcast-ftp-deploy-x7k9m2"
  TELEGRAM_BOT_TOKEN: "7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc"
  TELEGRAM_CHAT_ID: "-1002796302613_97"

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, curl, gd
          coverage: none

      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Prepare deployment
        run: |
          chmod -R 755 storage bootstrap/cache
          mkdir -p storage/framework/{cache,sessions,views}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          server-dir: /
          protocol: ftp
          port: 21
          timeout: 300000
          log-level: standard
          exclude: |
            **/.git*
            **/.git*/**
            .github/**
            .env
            .env.*
            .env.example
            tests/**
            phpunit.xml
            phpunit.xml.*
            .styleci.yml
            .editorconfig
            .phpunit*
            node_modules/**
            storage/logs/**
            storage/framework/sessions/**
            storage/framework/views/**
            storage/framework/cache/data/**
            .cursor/**
            .idea/**
            .vscode/**
            .fleet/**
            .zed/**
            .nova/**
            **/*.md
            docs/**
            *.sh
            *.bat
            scripts/**
            .ftp-deploy-sync-state.json
            docker-compose*
            Dockerfile*
            Makefile*
            .gitlab-ci.yml
            vendor/**/tests/**
            vendor/**/Tests/**
            vendor/**/*.md
            vendor/**/docs/**
            vendor/**/.github/**
            vendor/**/CHANGELOG*
            vendor/**/LICENSE*
            vendor/**/README*
            vendor/**/readme*
            vendor/**/phpunit.xml*
            vendor/**/.gitignore
            vendor/**/.editorconfig
            vendor/**/CONTRIBUTING*
            vendor/**/UPGRADE*
            vendor/**/SECURITY*
            vendor/**/.php-cs-fixer*
            vendor/**/.travis.yml
            vendor/**/.scrutinizer*
            vendor/**/Makefile

      - name: Post-deploy storage setup
        run: |
          echo "Running post-deploy storage setup..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${{ env.SITE_URL }}/_deploy_helper.php?token=${{ env.DEPLOY_TOKEN }}" \
            --max-time 30 --connect-timeout 10)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP $HTTP_CODE"
          echo "$BODY"

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "Post-deploy setup completed successfully"
          else
            echo "::warning::Post-deploy helper returned HTTP $HTTP_CODE ‚Äî storage link may need manual setup"
          fi

      - name: Notify Telegram (success)
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -c 200)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an)

          TEXT="‚úÖ *SarvCast Backend Deployed*

          üì¶ Commit: \`${COMMIT_HASH}\`
          üë§ Author: ${AUTHOR}
          üìù ${COMMIT_MSG}

          üîó ${{ env.SITE_URL }}"

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true || true

      - name: Notify Telegram (failure)
        if: failure()
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an)

          TEXT="‚ùå *SarvCast Backend Deploy Failed*

          üì¶ Commit: \`${COMMIT_HASH}\`
          üë§ Author: ${AUTHOR}

          üîó [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true || true

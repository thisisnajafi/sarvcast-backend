name: Deploy to Production

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '8.0'
          mysql root password: 'iWY]RgUhnqiu'
          mysql database: 'h273779_lgb'
          mysql user: 'h273779_lgb'
          mysql host: 'localhost'
          mysql password: 'iWY]RgUhnqiu'

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        env:
          BROADCAST_DRIVER: log
          PUSHER_APP_KEY: dummy_key
          PUSHER_APP_SECRET: dummy_secret
          PUSHER_APP_ID: dummy_id
          PUSHER_APP_CLUSTER: mt1
        run: composer install

      # - name: Copy .env
      #   env:
      #     BROADCAST_DRIVER: log
      #     PUSHER_APP_KEY: dummy_key
      #     PUSHER_APP_SECRET: dummy_secret
      #     PUSHER_APP_ID: dummy_id
      #     PUSHER_APP_CLUSTER: mt1
      #   run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      # - name: Configure database for GitHub Actions
      #   run: |
      #     # Update .env file with GitHub Actions database credentials
      #     sed -i 's/DB_HOST=.*/DB_HOST=localhost/' .env
      #     sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
      #     sed -i 's/DB_DATABASE=.*/DB_DATABASE=h273779_lgb/' .env
      #     sed -i 's/DB_USERNAME=.*/DB_USERNAME=h273779_lgb/' .env
      #     sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=iWY]RgUhnqiu/' .env

      # - name: Generate key
      #   env:
      #     BROADCAST_DRIVER: log
      #     PUSHER_APP_KEY: dummy_key
      #     PUSHER_APP_SECRET: dummy_secret
      #     PUSHER_APP_ID: dummy_id
      #     PUSHER_APP_CLUSTER: mt1
      #   run: php artisan key:generate --force

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Test Database Connection
        run: |
          echo "ðŸ” Testing database connection..."
          php artisan tinker --execute="echo 'Database connection: ' . (DB::connection()->getPdo() ? 'OK' : 'FAILED') . PHP_EOL;"


        
      - name: Pre-deployment Cache Clear
        run: |
          echo "ðŸ§¹ Clearing pre-deployment caches..."
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          echo "âœ… Pre-deployment caches cleared"




      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@4.0.0
        with:
          server: ftp.sarvcast.ir
          username: my@sarvcast.ir
          password: Prof48017421@#
          local-dir: ./deployment/
          server-dir: /
          exclude: |
            .env
            .env.*
      - name: Prepare Server Instructions
        run: |
          echo "ðŸ“‹ After FTP upload completes, run these commands on your server:"
          echo ""
          echo "ðŸ”§ Essential Server Setup Commands:"
          echo "1. Navigate to your application directory"
          echo "2. Run: composer install --no-dev --optimize-autoloader --no-interaction"
          echo "3. Run: php artisan config:clear"
          echo "4. Run: php artisan route:clear"
          echo "5. Run: php artisan view:clear"
          echo "6. Run: php artisan cache:clear"
          echo ""
          echo "ðŸš« To disable all caching, add to .env:"
          echo "DISABLE_ALL_CACHING=true"
          echo ""
          echo "âœ… This will ensure your application works properly on the server."

      - name: Verify deployment
        run: |
          echo "âœ… Deployment verification..."
          echo "ðŸ“‹ Deployment completed successfully!"
          echo ""
          echo "ðŸŽ‰ Your SarvCast application has been deployed!"
          echo ""
          echo "ðŸ”§ What was done:"
          echo "  âœ… Files deployed via FTP (vendor excluded)"
          echo "  âœ… Caches cleared before deployment"
          echo "  âœ… Ready for server setup"


      - name: Notify Telegram
        env:
          TELEGRAM_BOT_TOKEN: 7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc
          TELEGRAM_CHAT_ID: -1002796302613_97
          GITHUB_ACTOR: ${{ github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=ðŸš€ *SarvCast Deployment Successful*

          *Branch:* \`${{ github.ref_name }}\`
          *Commit:* \`${{ github.sha }}\`
          *Author:* ${{ github.actor }}

          *Changes:*
          ${{ github.event.head_commit.message }}

          *Status:* âœ… Deployed to production

          *Deployment Details:*
          â€¢ Application files uploaded to FTP server
          â€¢ Vendor folder excluded for faster upload
          â€¢ AWS/Docker dependencies removed

          *Next Steps:*
          â€¢ Run \`./server-setup.sh\` on server (automated)
          â€¢ Or follow manual setup instructions
          â€¢ AWS cache will be cleared automatically

          ðŸ”— [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"
            
on:
  push:
    branches:
      - main

name: üöÄ Deploy website on push (Master)

env:
  FTP_SERVER: "ftp.sarvcast.ir"
  FTP_USERNAME: "my@sarvcast.ir"
  FTP_PASSWORD: "Prof48017421@#"
  SITE_URL: "https://my.sarvcast.ir"
  DEPLOY_TOKEN: "sarvcast_deploy_key_2026"
  TELEGRAM_BOT_TOKEN: "7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc"
  TELEGRAM_CHAT_ID: "-1002796302613_97"

jobs:
  web-deploy:
    name: üéâ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Prepare deployment
        run: |
          chmod -R 777 storage bootstrap/cache

          cat > _deploy_helper.php << 'HELPERSCRIPT'
          <?php
          if (($_GET['token'] ?? '') !== 'sarvcast_deploy_key_2026') {
              http_response_code(403);
              die(json_encode(['error' => 'Unauthorized']));
          }
          $results = [];
          $baseDir = rtrim(__DIR__, '/');
          $publicDir = $baseDir . '/public';

          // Create storage symlink
          $link = $publicDir . '/storage';
          $target = $baseDir . '/storage/app/public';
          if (is_link($link)) {
              $results[] = 'Storage symlink already exists';
          } elseif (!file_exists($link)) {
              if (@symlink($target, $link)) {
                  $results[] = 'Storage symlink created';
              } else {
                  @mkdir($link, 0755, true);
                  file_put_contents($link . '/.htaccess',
                      "RewriteEngine On\nRewriteRule ^(.*)$ /storage/app/public/$1 [L]");
                  $results[] = '.htaccess redirect fallback created';
              }
          }

          // Ensure required directories exist
          foreach ([
              'storage/app/public', 'storage/framework/cache/data',
              'storage/framework/sessions', 'storage/framework/views',
              'storage/logs', 'bootstrap/cache',
          ] as $dir) {
              $full = $baseDir . '/' . $dir;
              if (!is_dir($full)) { @mkdir($full, 0755, true); $results[] = "Created: $dir"; }
          }

          // Ensure public image directories exist
          foreach (['images/categories','images/stories','images/episodes',
                     'images/people','images/users','images/playlists','images/timeline'] as $d) {
              $p = $publicDir . '/' . $d;
              if (!is_dir($p)) { @mkdir($p, 0755, true); }
          }

          // Verify critical files
          foreach (['vendor/autoload.php','artisan','public/index.php'] as $f) {
              $results[] = (file_exists($baseDir.'/'.$f) ? 'OK' : 'MISSING') . ': ' . $f;
          }

          @unlink(__FILE__);
          $results[] = 'Helper script removed';
          header('Content-Type: application/json');
          echo json_encode(['success' => true, 'results' => $results], JSON_PRETTY_PRINT);
          HELPERSCRIPT

      - name: üìÇ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          server-dir: /
          protocol: ftps
          port: 21
          timeout: 60000
          security: loose
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            .github/**
            .env
            .env.*
            tests/**
            phpunit.xml
            .styleci.yml
            node_modules/**
            storage/logs/**
            storage/framework/sessions/**
            storage/framework/views/**

      - name: üîó Create storage link
        run: |
          echo "Running post-deploy setup..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${{ env.SITE_URL }}/_deploy_helper.php?token=${{ env.DEPLOY_TOKEN }}" \
            --max-time 30)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Storage link setup completed!"
          else
            echo "‚ö†Ô∏è WARNING: Setup returned $HTTP_CODE (non-critical)"
          fi

      - name: üì¢ Notify Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS_TEXT="Deployment Complete"
          else
            EMOJI="‚ùå"
            STATUS_TEXT="Deployment Failed"
          fi

          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          FORMATTED=$(echo "${COMMIT_MESSAGE}" | sed 's/$/\\n/' | sed ':a;N;$!ba;s/\n/\\n/g')
          MESSAGE=$(echo -e "${EMOJI} <b>SarvCast Backend</b> ${EMOJI}\n\n<b>Status:</b> ${STATUS_TEXT}\n<b>User:</b> ${{ github.actor }}\n<blockquote>${FORMATTED}</blockquote>")

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" || echo "Telegram notification failed"

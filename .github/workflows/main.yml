on:
  push:
    branches:
      - main

name: üöÄ Deploy website on push (Main)

env:
  FTP_SERVER: "ftp.sarvcast.ir"
  FTP_USERNAME: "my@sarvcast.ir"
  FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}          # ‚Üê move to repo secrets!
  SITE_URL: "https://my.sarvcast.ir"
  DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}          # ‚Üê also secret
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  web-deploy:
    name: üéâ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: \( {{ runner.os }}-php- \){{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Prepare deployment
        run: |
          chmod -R 777 storage bootstrap/cache

          # (your _deploy_helper.php script remains the same)
          cat > _deploy_helper.php << 'HELPERSCRIPT'
          <?php
          # ... (your original script content here - no change needed)
          HELPERSCRIPT

      - name: üîç Test FTP connectivity
        run: |
          echo "=== Testing connection to ${{ env.FTP_SERVER }} ==="
          echo "Runner IP:" && curl -s ifconfig.me || echo "Could not detect IP"
          echo ""
          echo "--- Testing port 21 (FTP) ---"
          timeout 10 bash -c "echo > /dev/tcp/${{ env.FTP_SERVER }}/21" 2>&1 && echo "Port 21: OPEN" || echo "Port 21: CLOSED/BLOCKED"
          echo "--- Testing port 990 (FTPS) ---"
          timeout 10 bash -c "echo > /dev/tcp/${{ env.FTP_SERVER }}/990" 2>&1 && echo "Port 990: OPEN" || echo "Port 990: CLOSED/BLOCKED"
          echo "--- Testing port 22 (SSH/SFTP) ---"
          timeout 10 bash -c "echo > /dev/tcp/${{ env.FTP_SERVER }}/22" 2>&1 && echo "Port 22: OPEN" || echo "Port 22: CLOSED/BLOCKED"
          echo "--- DNS lookup ---"
          nslookup ${{ env.FTP_SERVER }} || echo "DNS lookup failed"

      - name: üìÇ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server:     ${{ env.FTP_SERVER }}
          username:   ${{ env.FTP_USERNAME }}
          password:   ${{ env.FTP_PASSWORD }}
          server-dir: /
          protocol:   ftp
          port:       21
          timeout:    6000000          # ‚Üê 5 minutes ‚Äî the most important fix
          log-level:  verbose
          exclude: |
            **/.git*
            **/.git*/**
            .github/**
            .env
            .env.*
            tests/**
            phpunit.xml
            .styleci.yml
            node_modules/**
            storage/logs/**
            storage/framework/sessions/**
            storage/framework/views/**

      - name: üîó Create storage link
        run: |
          echo "Running post-deploy setup..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "\( {{ env.SITE_URL }}/_deploy_helper.php?token= \){{ env.DEPLOY_TOKEN }}" \
            --max-time 60 --connect-timeout 15)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "‚úÖ Storage link setup completed!"
          else
            echo "‚ö†Ô∏è Setup returned $HTTP_CODE ‚Äî check manually if needed"
          fi

      - name: üì¢ Notify Telegram
        if: always()
        run: |
          # (your notification script - no major change needed)
          # ...
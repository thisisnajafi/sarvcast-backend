name: SarvCast Backend Deploy

on:
  push:
    branches:
      - main

env:
  FTP_SERVER: "ftp.sarvcast.ir"
  FTP_USERNAME: "my@sarvcast.ir"
  FTP_PASSWORD: "Prof48017421@#"
  SITE_URL: "https://my.sarvcast.ir"
  DEPLOY_TOKEN: "sarvcast_deploy_key_2026"
  TELEGRAM_BOT_TOKEN: "7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc"
  TELEGRAM_CHAT_ID: "-1002796302613_97"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Generate deploy helper
        run: |
          cat > public/deploy_helper.php << 'DEPLOY_SCRIPT'
          <?php
          $token = $_GET['token'] ?? '';
          if ($token !== 'sarvcast_deploy_key_2026') {
              http_response_code(403);
              echo json_encode(['error' => 'Unauthorized']);
              exit;
          }
          $results = [];
          $publicStorage = __DIR__ . '/storage';
          $storageTarget = dirname(__DIR__) . '/storage/app/public';
          if (is_link($publicStorage)) {
              $results[] = 'Storage symlink already exists';
          } elseif (file_exists($publicStorage)) {
              $results[] = 'WARNING: public/storage exists but is not a symlink';
          } else {
              if (@symlink($storageTarget, $publicStorage)) {
                  $results[] = 'Storage symlink created';
              } else {
                  $results[] = 'ERROR: Failed to create storage symlink';
              }
          }
          foreach ([
              dirname(__DIR__) . '/storage/app/public',
              dirname(__DIR__) . '/storage/framework/cache',
              dirname(__DIR__) . '/storage/framework/sessions',
              dirname(__DIR__) . '/storage/framework/views',
              dirname(__DIR__) . '/storage/logs',
              dirname(__DIR__) . '/bootstrap/cache',
          ] as $dir) {
              if (!is_dir($dir)) { @mkdir($dir, 0755, true); $results[] = "Created: $dir"; }
          }
          foreach (['images/categories','images/stories','images/episodes','images/people','images/users','images/playlists','images/timeline'] as $d) {
              $p = __DIR__ . '/' . $d;
              if (!is_dir($p)) { @mkdir($p, 0755, true); $results[] = "Created: public/$d"; }
          }
          @unlink(__FILE__);
          $results[] = 'Deploy helper removed';
          header('Content-Type: application/json');
          echo json_encode(['success' => true, 'results' => $results], JSON_PRETTY_PRINT);
          DEPLOY_SCRIPT

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Deploy via FTP (lftp)
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq lftp

          echo "Starting FTP upload with lftp (parallel transfers)..."

          lftp -c "
            set ftp:ssl-allow no;
            set net:timeout 60;
            set net:max-retries 5;
            set net:reconnect-interval-base 5;
            set net:reconnect-interval-multiplier 1;
            set mirror:parallel-transfer-count 5;
            set mirror:use-pget-n 5;
            set ftp:passive-mode yes;
            set xfer:log no;

            open -u ${{ env.FTP_USERNAME }},'${{ env.FTP_PASSWORD }}' ${{ env.FTP_SERVER }};

            mirror --reverse --verbose --delete \
              --parallel=5 \
              --exclude-glob .git/ \
              --exclude-glob .github/ \
              --exclude-glob .env \
              --exclude-glob .env.* \
              --exclude-glob tests/ \
              --exclude-glob phpunit.xml \
              --exclude-glob .styleci.yml \
              --exclude-glob node_modules/ \
              --exclude-glob storage/logs/*.log \
              --exclude-glob storage/framework/cache/data/ \
              --exclude-glob storage/framework/sessions/ \
              --exclude-glob storage/framework/views/*.php \
              ./ /;

            bye;
          "

          echo "FTP upload completed"

      - name: Create storage link on server
        run: |
          echo "Calling deploy helper to create storage symlink..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${{ env.SITE_URL }}/deploy_helper.php?token=${{ env.DEPLOY_TOKEN }}" \
            --max-time 30)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Storage link and post-deploy tasks completed successfully"
          else
            echo "Deploy helper returned status $HTTP_CODE (may have already run or self-destructed)"
          fi

      - name: Notify Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            STATUS_TEXT="Deployment Complete"
          else
            EMOJI="❌"
            STATUS_TEXT="Deployment Failed"
          fi

          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          FORMATTED=$(echo "${COMMIT_MESSAGE}" | sed 's/$/\\n/' | sed ':a;N;$!ba;s/\n/\\n/g')
          MESSAGE=$(echo -e "${EMOJI} <b>SarvCast Backend</b> ${EMOJI}\n\n<b>Status:</b> ${STATUS_TEXT}\n<b>User:</b> ${{ github.actor }}\n<blockquote>${FORMATTED}</blockquote>")

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" || echo "Telegram notification failed"

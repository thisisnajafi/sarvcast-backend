name: SarvCast Backend Deploy

on:
  push:
    branches:
      - main

env:
  FTP_SERVER: "ftp.sarvcast.ir"
  FTP_USERNAME: "my@sarvcast.ir"
  FTP_PASSWORD: "Prof48017421@#"
  SITE_URL: "https://my.sarvcast.ir"
  DEPLOY_TOKEN: "sarvcast_deploy_key_2026"
  TELEGRAM_BOT_TOKEN: "7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc"
  TELEGRAM_CHAT_ID: "-1002796302613_97"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Prepare deployment
        run: |
          chmod -R 777 storage bootstrap/cache

          cat > _deploy_helper.php << 'HELPERSCRIPT'
          <?php
          if (($_GET['token'] ?? '') !== 'sarvcast_deploy_key_2026') {
              http_response_code(403);
              die(json_encode(['error' => 'Unauthorized']));
          }
          $results = [];
          $baseDir = rtrim(__DIR__, '/');
          $publicDir = $baseDir . '/public';

          // Storage symlink
          $link = $publicDir . '/storage';
          $target = $baseDir . '/storage/app/public';
          if (is_link($link)) {
              $results[] = 'Storage symlink already exists';
          } elseif (!file_exists($link)) {
              if (@symlink($target, $link)) {
                  $results[] = 'Storage symlink created';
              } else {
                  @mkdir($link, 0755, true);
                  file_put_contents($link . '/.htaccess',
                      "RewriteEngine On\nRewriteRule ^(.*)$ /storage/app/public/$1 [L]");
                  $results[] = '.htaccess redirect fallback created';
              }
          }

          foreach ([
              'storage/app/public', 'storage/framework/cache/data',
              'storage/framework/sessions', 'storage/framework/views',
              'storage/logs', 'bootstrap/cache',
          ] as $dir) {
              $full = $baseDir . '/' . $dir;
              if (!is_dir($full)) { @mkdir($full, 0755, true); $results[] = "Created: $dir"; }
          }
          foreach (['images/categories','images/stories','images/episodes',
                     'images/people','images/users','images/playlists','images/timeline'] as $d) {
              $p = $publicDir . '/' . $d;
              if (!is_dir($p)) { @mkdir($p, 0755, true); }
          }

          // Verify key files
          foreach (['vendor/autoload.php','artisan','public/index.php'] as $f) {
              $results[] = (file_exists($baseDir.'/'.$f) ? 'OK' : 'MISSING') . ': ' . $f;
          }

          @unlink(__FILE__);
          $results[] = 'Helper script removed';
          header('Content-Type: application/json');
          echo json_encode(['success' => true, 'results' => $results], JSON_PRETTY_PRINT);
          HELPERSCRIPT

      - name: Deploy via FTP
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq lftp > /dev/null 2>&1

          echo "Starting FTP mirror..."

          lftp -c "
            set ftp:ssl-allow no;
            set net:timeout 30;
            set net:max-retries 5;
            set net:reconnect-interval-base 5;
            set ftp:passive-mode yes;
            set mirror:parallel-transfer-count 5;
            set mirror:use-pget-n 5;

            open -u ${{ env.FTP_USERNAME }},'${{ env.FTP_PASSWORD }}' ${{ env.FTP_SERVER }};

            mirror --reverse --delete --verbose --only-newer --parallel=5 \
              --exclude ^\.git/ \
              --exclude ^\.github/ \
              --exclude ^\.env \
              --exclude ^tests/ \
              --exclude ^phpunit\.xml \
              --exclude ^node_modules/ \
              --exclude ^storage/logs/ \
              --exclude ^storage/framework/sessions/ \
              --exclude ^storage/framework/views/ \
              --exclude ^_deploy_helper\.php \
              . .;

            put _deploy_helper.php;

            bye;
          "

          echo "FTP mirror completed"

      - name: Setup storage link
        run: |
          echo "Running post-deploy setup..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${{ env.SITE_URL }}/_deploy_helper.php?token=${{ env.DEPLOY_TOKEN }}" \
            --max-time 30)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Setup completed successfully!"
          else
            echo "WARNING: Setup returned $HTTP_CODE (non-critical)"
          fi

      - name: Notify Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            STATUS_TEXT="Deployment Complete"
          else
            EMOJI="❌"
            STATUS_TEXT="Deployment Failed"
          fi

          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          FORMATTED=$(echo "${COMMIT_MESSAGE}" | sed 's/$/\\n/' | sed ':a;N;$!ba;s/\n/\\n/g')
          MESSAGE=$(echo -e "${EMOJI} <b>SarvCast Backend</b> ${EMOJI}\n\n<b>Status:</b> ${STATUS_TEXT}\n<b>User:</b> ${{ github.actor }}\n<blockquote>${FORMATTED}</blockquote>")

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" || echo "Telegram notification failed"

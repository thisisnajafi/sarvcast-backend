name: SarvCast Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '8.0'
          mysql root password: 'iWY]RgUhnqiu'
          mysql database: 'h273779_lgb'
          mysql user: 'h273779_lgb'
          mysql password: 'iWY]RgUhnqiu'

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        env:
          BROADCAST_DRIVER: log
          PUSHER_APP_KEY: dummy_key
          PUSHER_APP_SECRET: dummy_secret
          PUSHER_APP_ID: dummy_id
          PUSHER_APP_CLUSTER: mt1
        run: composer install


      # - name: Copy .env
      #   env:
      #     BROADCAST_DRIVER: log
      #     PUSHER_APP_KEY: dummy_key
      #     PUSHER_APP_SECRET: dummy_secret
      #     PUSHER_APP_ID: dummy_id
      #     PUSHER_APP_CLUSTER: mt1
      #   run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      # - name: Configure database for GitHub Actions
      #   run: |
      #     # Update .env file with GitHub Actions database credentials
      #     sed -i 's/DB_HOST=.*/DB_HOST=localhost/' .env
      #     sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
      #     sed -i 's/DB_DATABASE=.*/DB_DATABASE=h273779_lgb/' .env
      #     sed -i 's/DB_USERNAME=.*/DB_USERNAME=h273779_lgb/' .env
      #     sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=iWY]RgUhnqiu/' .env

      - name: Generate key
        env:
          BROADCAST_DRIVER: log
          PUSHER_APP_KEY: dummy_key
          PUSHER_APP_SECRET: dummy_secret
          PUSHER_APP_ID: dummy_id
          PUSHER_APP_CLUSTER: mt1
        run: php artisan key:generate --force

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Create Public Images Directories
        run: |
          echo "ðŸ“ Creating public images directories..."
          mkdir -p public/images/categories
          mkdir -p public/images/stories
          mkdir -p public/images/episodes
          mkdir -p public/images/people
          mkdir -p public/images/users
          mkdir -p public/images/playlists
          mkdir -p public/images/timeline
          echo "âœ… Public images directories created successfully"

      - name: Set Public Images Permissions
        run: |
          echo "ðŸ” Setting public images permissions..."
          chmod -R 755 public/images
          echo "âœ… Public images permissions set successfully"

      - name: Test Database Connection
        run: |
          echo "ðŸ” Testing database connection..."
          php artisan tinker --execute="echo 'Database connection: ' . (DB::connection()->getPdo() ? 'OK' : 'FAILED') . PHP_EOL;"


      - name: Pre-deployment Cache Clear
        run: |
          echo "ðŸ§¹ Clearing pre-deployment caches..."
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          echo "âœ… Pre-deployment caches cleared"

      - name: ðŸ“‚ Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.0.0
        with:
          server: ftp.sarvcast.ir
          username: my@sarvcast.ir
          password: Prof48017421@#
          server-dir: /
          exclude: |
            .env
            .env.*
            node_modules/
            .git/
            .github/
            tests/
            phpunit.xml
            *.md
            .styleci.yml
            storage/logs/*
            storage/framework/cache/*
            storage/framework/sessions/*
            storage/framework/views/*
            bootstrap/cache/*
            vendor

      - name: Setup SSH Authentication
        run: |
          echo "ðŸ”‘ Setting up SSH authentication for post-deployment commands..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Add server to known hosts
          echo "ðŸ” Adding server to known hosts..."
          ssh-keyscan -H ${{ secrets.SSH_HOST }} -p ${{ secrets.SSH_PORT || 22 }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

          # Install sshpass for password authentication
          echo "ðŸ“¦ Installing sshpass for password authentication..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq sshpass

          # Test SSH connection with password
          echo "ðŸ” Testing SSH connection with password..."
          if sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -o ConnectTimeout=10 \
            -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "echo 'SSH connection successful'" 2>&1; then
            echo "âœ… SSH connection test successful"
          else
            echo "âŒ SSH connection test failed"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify SSH_PASSWORD secret is correct"
            echo "2. Check SSH_USERNAME and SSH_HOST are correct"
            echo "3. Verify SSH port is correct (default: 22)"
            echo "4. Check server allows password authentication"
            echo "5. Check server firewall allows SSH connections"
            exit 1
          fi

          echo "âœ… SSH authentication configured successfully"

      - name: Upload Deployment Scripts
        run: |
          echo "ðŸ“¤ Uploading deployment scripts to server..."

          # Static APP_PATH for SSH commands
          APP_PATH="/home/sarvca/public_html/my"
          echo "ðŸ“ Application path: $APP_PATH"

          # Upload backup script
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -P ${{ secrets.SSH_PORT || 22 }} \
            scripts/backup-database-ssh.sh \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${APP_PATH}/scripts/backup-database-ssh.sh || true

          # Upload safe migration script
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -P ${{ secrets.SSH_PORT || 22 }} \
            scripts/safe-migrate.sh \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${APP_PATH}/scripts/safe-migrate.sh || true

          echo "âœ… Scripts uploaded successfully"

      - name: Backup Database Before Deployment
        run: |
          echo "ðŸ’¾ Creating database backup before deployment..."

          # Static APP_PATH for SSH commands
          APP_PATH="/home/sarvca/public_html/my"
          echo "ðŸ“ Application path: $APP_PATH"

          BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Determine backup directory (use secret or default to app-relative path)
          BACKUP_DIR_SECRET="${{ secrets.BACKUP_DIR }}"
          if [ -z "$BACKUP_DIR_SECRET" ]; then
            BACKUP_DIR_TO_USE="${APP_PATH}/storage/backups"
          else
            BACKUP_DIR_TO_USE="$BACKUP_DIR_SECRET"
          fi

          echo "ðŸ’¾ Backup directory: $BACKUP_DIR_TO_USE"

          # Create backup on server
          BACKUP_OUTPUT=$(sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -o ConnectTimeout=10 \
            -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "set -e && \
            echo 'ðŸ” Checking application path...' && \
            if [ ! -d '$APP_PATH' ]; then \
              echo 'âŒ ERROR: Application path does not exist: $APP_PATH' && \
              echo 'Please check your APP_PATH GitHub secret or create the directory' && \
              exit 1; \
            fi && \
            cd '$APP_PATH' && \
            echo 'âœ… Changed to application directory: $APP_PATH' && \
            BACKUP_DIR_VAR='$BACKUP_DIR_TO_USE' && \
            echo 'ðŸ’¾ Backup directory will be: '\$BACKUP_DIR_VAR && \
            if [ -f scripts/backup-database-ssh.sh ]; then \
              echo 'ðŸ“œ Using backup script...' && \
              chmod +x scripts/backup-database-ssh.sh && \
              mkdir -p \"\${BACKUP_DIR_VAR}\" && \
              BACKUP_DIR=\"\${BACKUP_DIR_VAR}\" ./scripts/backup-database-ssh.sh pre_deployment_${BACKUP_TIMESTAMP} 2>&1; \
            else \
              echo 'âš ï¸  Backup script not found, creating manual backup...' && \
              mkdir -p \"\${BACKUP_DIR_VAR}\" && \
              if [ -f .env ]; then \
                echo 'ðŸ“„ Loading database credentials from .env...' && \
                export \$(grep -v '^#' .env | grep -E '^DB_' | xargs) && \
                echo 'ðŸ’¾ Creating database backup...' && \
                mysqldump -h \${DB_HOST:-localhost} -P \${DB_PORT:-3306} -u \${DB_USERNAME} -p\${DB_PASSWORD} --single-transaction \${DB_DATABASE} | gzip > \"\${BACKUP_DIR_VAR}/pre_deployment_${BACKUP_TIMESTAMP}.sql.gz\" && \
                echo \"\${BACKUP_DIR_VAR}/pre_deployment_${BACKUP_TIMESTAMP}.sql.gz\"; \
              else \
                echo 'âŒ ERROR: .env file not found in $APP_PATH' && \
                exit 1; \
              fi; \
            fi")

          # Extract backup file path from output
          echo "ðŸ“‹ Backup output:"
          echo "$BACKUP_OUTPUT"

          # Try to extract backup file path (supports both /backups/sarvcast and app/storage/backups)
          BACKUP_FILE=$(echo "$BACKUP_OUTPUT" | grep -E '(/backups/sarvcast|storage/backups)/.*\.sql\.gz$' | tail -n 1 || echo "")

          if [ -n "$BACKUP_FILE" ]; then
            echo "âœ… Database backup created: $BACKUP_FILE"
            echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV
          else
            # Fallback: construct expected backup path
            BACKUP_FILE="${BACKUP_DIR_TO_USE}/pre_deployment_${BACKUP_TIMESTAMP}.sql.gz"
            echo "âš ï¸  Could not extract backup file path from output"
            echo "âš ï¸  Assuming backup is at: $BACKUP_FILE"
            echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV
          fi

      - name: Run Post-Deployment Commands via SSH
        run: |
          echo "ðŸš€ Running post-deployment commands via SSH..."

          # Static APP_PATH for SSH commands
          APP_PATH="/home/sarvca/public_html/my"
          BACKUP_FILE="${{ env.BACKUP_FILE }}"

          echo "ðŸ“ Application path: $APP_PATH"
          echo "ðŸ’¾ Backup file: $BACKUP_FILE"

          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -o ConnectTimeout=10 \
            -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "set -e && \
            echo 'ðŸ” Verifying application path...' && \
            if [ ! -d '$APP_PATH' ]; then \
              echo 'âŒ ERROR: Application path does not exist: $APP_PATH' && \
              exit 1; \
            fi && \
            cd '$APP_PATH' && \
            echo 'âœ… Changed to application directory' && \
            echo 'ðŸš€ Starting post-deployment setup...' && \
            echo 'ðŸ“¦ Installing/updating Composer dependencies...' && \
            composer install --no-dev --optimize-autoloader --no-interaction && \
            echo 'ðŸ§¹ Clearing Laravel caches...' && \
            php artisan config:clear && \
            php artisan route:clear && \
            php artisan view:clear && \
            php artisan cache:clear && \
            echo 'ðŸ”„ Running database migrations safely...' && \
            if [ -f scripts/update-database.sh ]; then \
              chmod +x scripts/update-database.sh && \
              BACKUP_DIR=\"$APP_PATH/storage/backups\" LOG_FILE=\"/tmp/sarvcast-db-update.log\" ./scripts/update-database.sh || { \
                echo 'âŒ Migration failed! Backup available at: ${BACKUP_FILE}' && \
                echo 'To restore, run: scripts/restore-database.sh ${BACKUP_FILE}' && \
                exit 1; \
              }; \
            elif [ -f scripts/safe-migrate.sh ]; then \
              chmod +x scripts/safe-migrate.sh && \
              BACKUP_DIR=\"$APP_PATH/storage/backups\" LOG_FILE=\"/tmp/sarvcast-db-update.log\" ./scripts/safe-migrate.sh --rollback-on-failure || { \
                echo 'âŒ Migration failed! Backup available at: ${BACKUP_FILE}' && \
                echo 'To restore, run: scripts/restore-database.sh ${BACKUP_FILE}' && \
                exit 1; \
              }; \
            else \
              echo 'âš ï¸  Safe migration script not found, using standard migrate...' && \
              php artisan migrate --force || { \
                echo 'âŒ Migration failed! Backup available at: ${BACKUP_FILE}' && \
                exit 1; \
              }; \
            fi && \
            echo 'âš¡ Optimizing Laravel for production...' && \
            php artisan config:cache && \
            php artisan route:cache && \
            php artisan view:cache && \
            php artisan optimize && \
            echo 'ðŸ” Setting proper permissions...' && \
            chmod -R 755 storage bootstrap/cache && \
            chmod -R 755 public/images && \
            echo 'ðŸ”— Creating storage symlink (if needed)...' && \
            php artisan storage:link || true && \
            echo 'âœ… Post-deployment setup completed successfully!'"

      - name: Create Post-Deployment Backup
        run: |
          echo "ðŸ’¾ Creating post-deployment backup..."

          # Static APP_PATH for SSH commands
          APP_PATH="/home/sarvca/public_html/my"
          BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR_TO_USE="${APP_PATH}/storage/backups"

          echo "ðŸ“ Application path: $APP_PATH"
          echo "ðŸ’¾ Backup directory: $BACKUP_DIR_TO_USE"

          POST_BACKUP_OUTPUT=$(sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -o ConnectTimeout=10 \
            -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "set -e && \
            cd '$APP_PATH' && \
            mkdir -p \"$BACKUP_DIR_TO_USE\" && \
            if [ -f scripts/backup-database-ssh.sh ]; then \
              chmod +x scripts/backup-database-ssh.sh && \
              BACKUP_DIR=\"$BACKUP_DIR_TO_USE\" ./scripts/backup-database-ssh.sh post_deployment_${BACKUP_TIMESTAMP} 2>&1; \
            else \
              echo 'âš ï¸  Backup script not found, creating manual backup...' && \
              if [ -f .env ]; then \
                export \$(grep -v '^#' .env | grep -E '^DB_' | xargs) && \
                mysqldump -h \${DB_HOST:-localhost} -P \${DB_PORT:-3306} -u \${DB_USERNAME} -p\${DB_PASSWORD} --single-transaction \${DB_DATABASE} | gzip > \"$BACKUP_DIR_TO_USE/post_deployment_${BACKUP_TIMESTAMP}.sql.gz\" && \
                echo \"$BACKUP_DIR_TO_USE/post_deployment_${BACKUP_TIMESTAMP}.sql.gz\"; \
              else \
                echo 'âŒ ERROR: .env file not found' && \
                exit 1; \
              fi; \
            fi")

          echo "ðŸ“‹ Post-backup output:"
          echo "$POST_BACKUP_OUTPUT"

          POST_BACKUP_FILE=$(echo "$POST_BACKUP_OUTPUT" | grep -E '(storage/backups|/backups/sarvcast)/.*\.sql\.gz$' | tail -n 1 || echo "")

          if [ -n "$POST_BACKUP_FILE" ]; then
            echo "âœ… Post-deployment backup created: $POST_BACKUP_FILE"
          else
            POST_BACKUP_FILE="$BACKUP_DIR_TO_USE/post_deployment_${BACKUP_TIMESTAMP}.sql.gz"
            echo "âš ï¸  Could not extract post-backup file path, assuming: $POST_BACKUP_FILE"
          fi

          echo "POST_BACKUP_FILE=$POST_BACKUP_FILE" >> $GITHUB_ENV

      - name: Collect Deployment Logs
        run: |
          echo "ðŸªµ Collecting deployment logs..."
          APP_PATH="/home/sarvca/public_html/my"
          mkdir -p logs

          # Fetch remote logs (best-effort)
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -P ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/tmp/sarvcast-*.log ./logs/ || true

          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -P ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${APP_PATH}/storage/logs/laravel.log ./logs/laravel.log || true

          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp \
            -o StrictHostKeyChecking=no \
            -o PasswordAuthentication=yes \
            -o PubkeyAuthentication=no \
            -P ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/tmp/sarvcast-db-update.log ./logs/sarvcast-db-update.log || true

          ls -la logs || true

      - name: Upload Deployment Logs
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: logs

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleanup completed"

      - name: Verify deployment
        run: |
          echo "âœ… Deployment verification..."
          echo "ðŸ“‹ Deployment completed successfully!"
          echo ""
          echo "ðŸŽ‰ Your SarvCast application has been deployed and optimized!"
          echo ""
          echo "ðŸ”§ What was done:"
          echo "  âœ… Files synced to server via FTP"
          echo "  âœ… Public images directories created"
          echo "  âœ… Permissions set correctly"
          echo "  âœ… Image directories configured"
          echo "  âœ… Composer dependencies installed/updated"
          echo "  âœ… Laravel caches cleared and optimized"
          echo "  âœ… Database migrations run"
          echo "  âœ… Application optimized for production"

      - name: Notify Telegram
        env:
          TELEGRAM_BOT_TOKEN: 7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc
          TELEGRAM_CHAT_ID: -1002796302613_97
          GITHUB_ACTOR: ${{ github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          FORMATTED_COMMIT_MESSAGE=$(echo "${COMMIT_MESSAGE}" | sed 's/$/\\n/' | sed ':a;N;$!ba;s/\n/\\n/g')
          MESSAGE=$(echo -e "ðŸ˜Ž <b>SarvCast Admin Dashboard</b> ðŸ˜Ž\n\nðŸ‘Œ <b>Status:</b> Deployment Complete\n\nðŸ‘¤ <b>User:</b> ${GITHUB_ACTOR}\n <blockquote>${FORMATTED_COMMIT_MESSAGE}</blockquote>")
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML"

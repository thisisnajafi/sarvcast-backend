on:
  push:
    branches:
      - main

name: Deploy Laravel Backend via FTP

env:
  FTP_SERVER: "ftp.sarvcast.ir"
  FTP_USERNAME: "my@sarvcast.ir"
  FTP_PASSWORD: "Prof48017421@#"
  SITE_URL: "https://my.sarvcast.ir"
  DEPLOY_TOKEN: "sarvcast-ftp-deploy-x7k9m2"
  TELEGRAM_BOT_TOKEN: "7488407974:AAFl4Ek9IanbvlkKlRoikQAqdkDtFYbD0Gc"
  TELEGRAM_CHAT_ID: "-1002796302613_97"

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          server-dir: /
          protocol: ftp
          port: 21
          timeout: 300000
          log-level: standard
          exclude: |
            **/.git*
            **/.git*/**
            .github/**
            .env
            .env.*
            .env.example
            vendor/**
            node_modules/**
            tests/**
            docs/**
            scripts/**
            storage/logs/**
            storage/framework/sessions/**
            storage/framework/views/**
            storage/framework/cache/data/**
            **/*.md
            *.sh
            *.bat
            phpunit.xml
            phpunit.xml.*
            .styleci.yml
            .editorconfig
            .phpunit*
            .cursor/**
            .idea/**
            .vscode/**
            .fleet/**
            .zed/**
            .nova/**
            .ftp-deploy-sync-state.json
            docker-compose*
            Dockerfile*
            Makefile*
            .gitlab-ci.yml

      - name: Clear and cache configurations
        run: |
          echo "::group::Clear and cache configurations (server)"
          echo "Calling deploy helper: clear-compiled, config:cache, route:cache, view:cache, optimize, storage:link"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${{ env.SITE_URL }}/_deploy_helper.php?token=${{ env.DEPLOY_TOKEN }}" \
            --max-time 90 --connect-timeout 15)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP status: $HTTP_CODE"

          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::warning::Deploy helper returned HTTP $HTTP_CODE ‚Äî may need manual cache clear"
            echo "Raw response: $BODY"
            echo "::endgroup::"
            exit 1
          fi

          # Log each command result from the helper so we can confirm all steps ran
          if command -v jq &>/dev/null; then
            STATUS=$(echo "$BODY" | jq -r '.status // "unknown"')
            echo "Helper status: $STATUS"
            echo "Command results:"
            echo "$BODY" | jq -r '.results[]?' 2>/dev/null | while read -r line; do
              echo "  - $line"
              if echo "$line" | grep -q "FAILED"; then
                echo "::warning::$line"
              fi
            done
            FAILED=$(echo "$BODY" | jq -r '[.results[]? | select(. | test("FAILED"))] | length' 2>/dev/null || echo "0")
            if [[ "$FAILED" != "0" ]]; then
              echo "::error::Clear cache incomplete: $FAILED command(s) failed on server"
              echo "::endgroup::"
              exit 1
            fi
          else
            echo "Raw response: $BODY"
          fi

          echo "‚úÖ Clear and cache configurations completed successfully (clear-compiled, config:cache, route:cache, view:cache, optimize, storage:link)"
          echo "::endgroup::"

      - name: Notify Telegram (success)
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -c 200)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an)

          TEXT="‚úÖ *SarvCast Backend Deployed*

          üì¶ Commit: \`${COMMIT_HASH}\`
          üë§ Author: ${AUTHOR}
          üìù ${COMMIT_MSG}

          üîó ${{ env.SITE_URL }}"

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true || true

      - name: Notify Telegram (failure)
        if: failure()
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=%an)

          TEXT="‚ùå *SarvCast Backend Deploy Failed*

          üì¶ Commit: \`${COMMIT_HASH}\`
          üë§ Author: ${AUTHOR}

          üîó [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true || true
